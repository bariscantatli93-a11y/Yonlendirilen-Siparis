<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>D√ºzce Sipari≈ü SaaS - Elite Pro</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { height: 55vh; width: 100%; border-radius: 20px; z-index: 10 !important; border: 3px solid white; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .order-card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 10px; border-left: 5px solid #3b82f6; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .method-badge { font-size: 10px; padding: 2px 8px; border-radius: 20px; font-weight: bold; text-transform: uppercase; }
        .whatsapp-btn { background-color: #25D366; color: white !important; padding: 10px; border-radius: 10px; font-weight: bold; display: block; text-align: center; margin-top: 10px; text-decoration: none; }
        #login-screen { position: fixed; inset: 0; background: linear-gradient(135deg, #3b82f6 0%, #1e3a8a 100%); z-index: 9999; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900">

    <div id="login-screen">
        <div class="w-full max-w-sm p-8 bg-white rounded-3xl shadow-2xl space-y-6 text-center">
            <h1 class="text-3xl font-black text-blue-700 tracking-tight">D√úZCE SAAS</h1>
            <p class="text-slate-400 text-sm">Lojistik Takip Sistemine Ho≈ügeldiniz</p>
            <select id="rest-select" class="w-full p-4 border-2 border-slate-100 rounded-2xl bg-slate-50 text-md font-bold outline-none focus:border-blue-500 transition-all">
                <option value="">Restoran Se√ßiniz</option>
                <option value="admin">Sƒ∞STEM Y√ñNETƒ∞Cƒ∞Sƒ∞</option>
                <option value="Merkez D√∂ner">Merkez D√∂ner (ƒ∞stanbul Cad.)</option>
                <option value="Krempark Pizza">Krempark Pizza</option>
                <option value="Spor Sokak Kebap">Spor Sokak Kebap</option>
                <option value="Konuralp Lezzet">Konuralp Lezzet</option>
            </select>
            <button onclick="handleLogin()" class="w-full bg-blue-600 text-white p-4 rounded-2xl font-bold text-lg shadow-lg hover:bg-blue-700 active:scale-95 transition-all">Giri≈ü Yap</button>
        </div>
    </div>

    <div id="main-panel" class="hidden">
        <header class="p-6 flex justify-between items-center">
            <div>
                <h2 id="welcome-text" class="text-xl font-bold">Panel</h2>
                <p class="text-xs text-slate-500" id="current-date">Canlƒ± Takip Aktif</p>
            </div>
            <button onclick="location.reload()" class="bg-white p-2 rounded-full shadow"><img src="https://img.icons8.com/material-outlined/24/000000/exit.png" width="20"/></button>
        </header>

        <div class="grid grid-cols-2 gap-4 px-6 mb-6">
            <div class="bg-white p-4 rounded-2xl shadow-sm"><p class="text-[10px] text-slate-400 font-bold uppercase">Ciro</p><p id="total-ciro" class="text-xl font-black text-blue-600">0</p></div>
            <div class="bg-white p-4 rounded-2xl shadow-sm"><p class="text-[10px] text-slate-400 font-bold uppercase">Paket</p><p id="total-adet" class="text-xl font-black text-emerald-500">0</p></div>
        </div>

        <div class="px-6 mb-6"><div id="map"></div></div>

        <div id="admin-area" class="hidden px-6">
            <h3 class="font-black text-lg mb-4 flex items-center gap-2">
                <span class="w-2 h-6 bg-blue-600 rounded-full"></span> Aktif Sipari≈ü Kartlarƒ±
            </h3>
            <div id="order-cards-list" class="space-y-4"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCi...",
            authDomain: "wpyonsip-6bbb5.firebaseapp.com",
            projectId: "wpyonsip-6bbb5",
            storageBucket: "wpyonsip-6bbb5.appspot.com",
            messagingSenderId: "338804071850",
            appId: "1:338804071850:web:138a2e5d590403756b66e3"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let map, userRole, currentRest;

        const kuryeler = [
            {isim: "Kurye Ahmet", lat: 40.8440, lng: 31.1570},
            {isim: "Kurye Mehmet", lat: 40.8410, lng: 31.1630},
            {isim: "Kurye Caner", lat: 40.8380, lng: 31.1520},
            {isim: "Kurye Ali", lat: 40.8480, lng: 31.1480},
            {isim: "Kurye Sel√ßuk", lat: 40.9080, lng: 31.1800},
            {isim: "Kurye Mustafa", lat: 40.8420, lng: 31.1650}
        ];

        const musteriler = ["Ay≈üe Teyze", "√ñƒürenci Mert", "Esnaf Osman Bey", "Avukat Ebru", "Doktor Selim", "Emekli Hasan Amca"];
        const odemeYontemleri = ["Nakit", "Kredi Kartƒ±", "Online √ñdeme"];

        function getDist(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2-lat1) * Math.PI / 180;
            const dLon = (lon2-lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return (R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))).toFixed(1);
        }

        function handleLogin() {
            currentRest = document.getElementById('rest-select').value;
            if(!currentRest) return alert("Se√ßim Yap!");
            userRole = (currentRest === 'admin') ? 'admin' : 'restoran';
            document.getElementById('login-screen').remove();
            document.getElementById('main-panel').classList.remove('hidden');
            document.getElementById('welcome-text').innerText = currentRest;
            if(userRole === 'admin') document.getElementById('admin-area').classList.remove('hidden');
            initMap();
            loadOrders();
            if(userRole !== 'admin') seedOrder();
        }

        function initMap() {
            map = L.map('map').setView([40.8438, 31.1565], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        }

        function seedOrder() {
            const kurye = kuryeler[Math.floor(Math.random() * kuryeler.length)];
            const dLat = 40.8425, dLng = 31.1590;
            const mLat = dLat + (Math.random() - 0.5) * 0.03;
            const mLng = dLng + (Math.random() - 0.5) * 0.03;

            db.collection("orders").add({
                restoran: currentRest,
                musteri: musteriler[Math.floor(Math.random() * musteriler.length)],
                tutar: Math.floor(Math.random() * 400) + 100,
                odeme: odemeYontemleri[Math.floor(Math.random() * odemeYontemleri.length)],
                lat: mLat, lng: mLng,
                kurye: kurye.isim, kLat: kurye.lat, kLng: kurye.lng,
                tarih: firebase.firestore.FieldValue.serverTimestamp()
            });
        }

        function loadOrders() {
            db.collection("orders").orderBy("tarih", "desc").onSnapshot(snapshot => {
                let stats = { c: 0, a: 0 };
                let cardsHtml = '';
                
                snapshot.forEach(doc => {
                    const d = doc.data();
                    if(userRole === 'admin' || d.restoran === currentRest) {
                        stats.c += d.tutar; stats.a++;
                        
                        const kuryeMesafe = getDist(d.kLat, d.kLng, 40.8425, 31.1590);
                        const teslimMesafe = getDist(40.8425, 31.1590, d.lat, d.lng);
                        const methodColor = d.odeme === 'Nakit' ? 'bg-orange-100 text-orange-600' : 'bg-emerald-100 text-emerald-600';

                        if(userRole === 'admin') {
                            cardsHtml += `
                                <div class="order-card">
                                    <div class="flex justify-between items-start mb-2">
                                        <span class="font-black text-blue-600">${d.restoran}</span>
                                        <span class="method-badge ${methodColor}">${d.odeme}</span>
                                    </div>
                                    <div class="text-sm font-bold text-slate-700">M√º≈üteri: ${d.musteri}</div>
                                    <div class="flex items-center gap-2 mt-2 text-[11px] text-slate-500">
                                        <span class="bg-slate-100 px-2 py-1 rounded">üöö ${d.kurye} (${kuryeMesafe} km)</span>
                                        <span class="bg-slate-100 px-2 py-1 rounded">üìç Teslimat: ${teslimMesafe} km</span>
                                    </div>
                                    <div class="mt-3 text-right font-black text-lg">${d.tutar} TL</div>
                                </div>`;
                        }

                        const waMsg = encodeURIComponent(`YENƒ∞ Sƒ∞PARƒ∞≈û!\nRestoran: ${d.restoran}\nM√º≈üteri: ${d.musteri}\nTutar: ${d.tutar} TL\nKurye: ${d.kurye}\nKonum: http://google.com/maps?q=${d.lat},${d.lng}`);
                        L.circleMarker([d.lat, d.lng], {color: '#3b82f6', radius: 10, fillOpacity: 0.9}).addTo(map)
                         .bindPopup(`<b>${d.musteri}</b><br>${d.tutar} TL<br><a href="https://wa.me/?text=${waMsg}" class="whatsapp-btn">Kuryeye WhatsApp At</a>`);
                    }
                });
                document.getElementById('total-ciro').innerText = stats.c + " TL";
                document.getElementById('total-adet').innerText = stats.a;
                if(userRole === 'admin') document.getElementById('order-cards-list').innerHTML = cardsHtml;
            });
        }
    </script>
</body>
</html>
