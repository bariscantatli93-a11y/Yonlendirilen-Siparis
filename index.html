<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sipariş SaaS - Profesyonel Yönetim Paneli</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #e63946; --secondary: #1d3557; --accent: #2ecc71; --admin: #8e44ad; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #f4f7f6; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Giriş Ekranı */
        #auth-screen { position: fixed; inset: 0; background: var(--secondary); z-index: 2000; display: flex; align-items: center; justify-content: center; color: white; }
        .login-box { background: white; color: #333; padding: 40px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 15px 35px rgba(0,0,0,0.5); }
        
        /* Dashboard */
        .header { background: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #ddd; }
        .stats-bar { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 10px; padding: 15px; background: #fff; }
        .stat-card { background: #fff; padding: 15px; border-radius: 12px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); border-bottom: 4px solid var(--primary); }
        .stat-card h5 { margin: 0; font-size: 13px; color: #777; text-transform: uppercase; }
        .stat-card p { margin: 8px 0 0 0; font-weight: bold; font-size: 18px; color: var(--secondary); }

        /* Harita ve Tablo */
        #main-container { flex: 1; display: flex; flex-direction: column; position: relative; }
        #map { flex: 1; z-index: 1; }
        
        /* Admin Tablosu */
        #admin-table-container { height: 200px; background: white; overflow-y: auto; display: none; border-top: 3px solid var(--admin); }
        table { width: 100%; border-collapse: collapse; font-size: 14px; }
        th { background: #f8f9fa; position: sticky; top: 0; padding: 12px; text-align: left; border-bottom: 2px solid #eee; }
        td { padding: 10px; border-bottom: 1px solid #eee; }

        /* Formlar */
        input, select, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 10px; border: 1px solid #ddd; outline: none; }
        .btn-primary { background: var(--primary); color: white; border: none; font-weight: bold; cursor: pointer; }
        
        /* Sipariş Modal */
        #order-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 25px; border-radius: 15px; z-index: 3000; box-shadow: 0 0 50px rgba(0,0,0,0.3); width: 320px; }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2900; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="login-box">
            <h2 style="color: var(--primary); margin-top: 0;">Restoran Paneli</h2>
            <input type="text" id="resName" placeholder="Restoran Adı">
            <input type="password" id="resPass" placeholder="Şifre">
            <button class="btn-primary" onclick="login()">GİRİŞ YAP</button>
            <p style="color: #666; font-size: 12px;">Admin: admin / 1234</p>
        </div>
    </div>

    <div class="header">
        <h3 id="panel-title" style="margin:0; color: var(--secondary);">Sipariş Paneli</h3>
        <button onclick="location.reload()" style="width: auto; padding: 5px 15px; font-size: 12px;">Çıkış Yap</button>
    </div>

    <div class="stats-bar" id="stats-panel" style="display:none;">
        <div class="stat-card"><h5>Toplam Ciro</h5><p id="st-total">0 TL</p></div>
        <div class="stat-card" style="border-color: #2ecc71"><h5>Nakit</h5><p id="st-cash">0 TL</p></div>
        <div class="stat-card" style="border-color: #3498db"><h5>Kredi Kartı</h5><p id="st-card">0 TL</p></div>
        <div class="stat-card" style="border-color: #f1c40f"><h5>Online</h5><p id="st-online">0 TL</p></div>
        <div class="stat-card" style="border-color: #e67e22"><h5>Sipariş</h5><p id="st-count">0</p></div>
    </div>

    <div id="main-container">
        <div id="map"></div>
        
        <div id="admin-table-container">
            <table>
                <thead>
                    <tr>
                        <th>Restoran</th>
                        <th>Toplam Sipariş</th>
                        <th>Nakit</th>
                        <th>Kart</th>
                        <th>Online</th>
                        <th>Toplam Ciro</th>
                    </tr>
                </thead>
                <tbody id="admin-tbody">
                    </tbody>
            </table>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>
    <div id="order-modal">
        <h3 style="margin-top:0">Yeni Sipariş</h3>
        <input type="number" id="orderPrice" placeholder="Tutar (TL)">
        <select id="orderPay">
            <option value="Nakit">Nakit</option>
            <option value="Kredi Kartı">Kredi Kartı</option>
            <option value="Online">Online</option>
        </select>
        <input type="text" id="orderItems" placeholder="Sipariş Detayı (Örn: 2 Kebap)">
        <select id="orderSource">
            <option value="Manuel">Manuel Giriş</option>
            <option value="Yemeksepeti">Yemeksepeti</option>
            <option value="Getir">Getir</option>
            <option value="Trendyol">Trendyol Go</option>
        </select>
        <button class="btn-primary" onclick="saveOrder()">Kaydet</button>
        <button onclick="closeModal()" style="background:#eee; border:none;">İptal</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAdoBPDNNfgW8AZxpR3-pUjH_M6_7D-X_U",
            authDomain: "wpyonsip-6bbb5.firebaseapp.com",
            projectId: "wpyonsip-6bbb5",
            storageBucket: "wpyonsip-6bbb5.firebasestorage.app",
            messagingSenderId: "478685413866",
            appId: "1:478685413866:web:86a86e92c6086e3f53831a"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentRes = "";
        let isAdmin = false;
        let map, markers = [];
        let tempCoords = null;

        function login() {
            const name = document.getElementById('resName').value.trim();
            const pass = document.getElementById('resPass').value;

            if(name === "admin" && pass === "1234") {
                isAdmin = true;
                currentRes = "Sistem Admini";
                document.getElementById('admin-table-container').style.display = 'block';
            } else if(name !== "" && pass !== "") {
                currentRes = name;
            } else { return alert("Bilgileri girin!"); }
            
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('stats-panel').style.display = 'grid';
            document.getElementById('panel-title').innerText = currentRes;
            initApp();
        }

        function initApp() {
            map = L.map('map').setView([39.9334, 32.8597], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            let query = db.collection("orders");
            if(!isAdmin) query = query.where("restaurant", "==", currentRes);

            query.onSnapshot(snapshot => {
                let stats = { total: 0, cash: 0, card: 0, online: 0, count: 0 };
                let resData = {}; // Admin tablosu için

                markers.forEach(m => map.removeLayer(m));
                markers = [];

                snapshot.forEach(doc => {
                    const o = doc.data();
                    const p = parseFloat(o.price) || 0;
                    
                    // İstatistikleri Hesapla
                    stats.count++;
                    stats.total += p;
                    if(o.pay === "Nakit") stats.cash += p;
                    if(o.pay === "Kredi Kartı") stats.card += p;
                    if(o.pay === "Online") stats.online += p;

                    // Admin Tablosu Gruplama
                    if(isAdmin) {
                        if(!resData[o.restaurant]) resData[o.restaurant] = { count:0, cash:0, card:0, online:0, total:0 };
                        resData[o.restaurant].count++;
                        resData[o.restaurant].total += p;
                        if(o.pay === "Nakit") resData[o.restaurant].cash += p;
                        if(o.pay === "Kredi Kartı") resData[o.restaurant].card += p;
                        if(o.pay === "Online") resData[o.restaurant].online += p;
                    }

                    // Haritaya Ekle
                    const color = o.source === "Yemeksepeti" ? "pink" : (o.source === "Getir" ? "purple" : "blue");
                    const marker = L.circleMarker([o.lat, o.lng], { color: color, radius: 8, fillOpacity: 0.8 }).addTo(map)
                        .bindPopup(`<b>${o.restaurant}</b><br>${o.items}<br>Tutar: ${p} TL<br>Kaynak: ${o.source}`);
                    markers.push(marker);
                });

                updateUI(stats, resData);
            });

            map.on('click', e => {
                if(isAdmin) return;
                tempCoords = e.latlng;
                document.getElementById('order-modal').style.display = 'block';
                document.getElementById('overlay').style.display = 'block';
            });
        }

        function updateUI(s, resData) {
            document.getElementById('st-total').innerText = s.total + " TL";
            document.getElementById('st-cash').innerText = s.cash + " TL";
            document.getElementById('st-card').innerText = s.card + " TL";
            document.getElementById('st-online').innerText = s.online + " TL";
            document.getElementById('st-count').innerText = s.count;

            if(isAdmin) {
                const tbody = document.getElementById('admin-tbody');
                tbody.innerHTML = "";
                for(let res in resData) {
                    tbody.innerHTML += `<tr>
                        <td><b>${res}</b></td>
                        <td>${resData[res].count}</td>
                        <td>${resData[res].cash} TL</td>
                        <td>${resData[res].card} TL</td>
                        <td>${resData[res].online} TL</td>
                        <td style="color:var(--primary); font-weight:bold;">${resData[res].total} TL</td>
                    </tr>`;
                }
            }
        }

        function saveOrder() {
            const p = document.getElementById('orderPrice').value;
            const pay = document.getElementById('orderPay').value;
            const item = document.getElementById('orderItems').value;
            const src = document.getElementById('orderSource').value;

            if(!p) return alert("Tutar girin!");

            db.collection("orders").add({
                restaurant: currentRes,
                price: p,
                pay: pay,
                items: item || "Detay yok",
                source: src,
                lat: tempCoords.lat,
                lng: tempCoords.lng,
                time: new Date().getTime()
            }).then(() => closeModal());
        }

        function closeModal() {
            document.getElementById('order-modal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('orderPrice').value = "";
            document.getElementById('orderItems').value = "";
        }
    </script>
</body>
</html>
    </div>

    <div class="stats-bar" id="stats-panel" style="display:none;">
        <div class="stat-card"><h5>Toplam</h5><p id="st-total">0 TL</p></div>
        <div class="stat-card" style="border-color: #25d366"><h5>Nakit</h5><p id="st-cash">0 TL</p></div>
        <div class="stat-card" style="border-color: #3498db"><h5>Kart</h5><p id="st-card">0 TL</p></div>
        <div class="stat-card" style="border-color: #f39c12"><h5>Online</h5><p id="st-online">0 TL</p></div>
        <div class="stat-card" style="border-color: #e74c3c"><h5>İptal</h5><p id="st-cancel">0</p></div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // FIREBASE CONFIG - SENİN BİLGİLERİNLE GÜNCELLENDİ
        const firebaseConfig = {
            apiKey: "AIzaSyAdoBPDNNfgW8AZxpR3-pUjH_M6_7D-X_U",
            authDomain: "wpyonsip-6bbb5.firebaseapp.com",
            projectId: "wpyonsip-6bbb5",
            storageBucket: "wpyonsip-6bbb5.firebasestorage.app",
            messagingSenderId: "478685413866",
            appId: "1:478685413866:web:86a86e92c6086e3f53831a"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentRes = "";
        let isAdmin = false;
        let map, markers = [];

        function login() {
            const name = document.getElementById('resName').value.trim();
            const pass = document.getElementById('resPass').value;

            if(name === "admin" && pass === "1234") {
                isAdmin = true;
                currentRes = "TÜM RESTORANLAR";
            } else if(name !== "" && pass !== "") {
                currentRes = name;
            } else {
                return alert("Bilgileri girin!");
            }
            
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('stats-panel').style.display = 'grid';
            initApp();
        }

        function initApp() {
            map = L.map('map').setView([39.9334, 32.8597], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            let query = db.collection("orders");
            if(!isAdmin) query = query.where("restaurant", "==", currentRes);

            query.onSnapshot(snapshot => {
                let stats = { total: 0, cash: 0, card: 0, online: 0, cancel: 0 };
                
                // Temizle
                markers.forEach(m => map.removeLayer(m));
                markers = [];

                snapshot.forEach(doc => {
                    const o = doc.data();
                    if(o.status === "iptal") {
                        stats.cancel++;
                    } else {
                        const price = parseFloat(o.price) || 0;
                        stats.total += price;
                        if(o.pay === "Nakit") stats.cash += price;
                        if(o.pay === "Kredi Kartı") stats.card += price;
                        if(o.pay === "Online") stats.online += price;
                    }
                    
                    const marker = L.marker([o.lat, o.lng]).addTo(map)
                        .bindPopup(`<b>${o.restaurant}</b><br>Tutar: ${o.price} TL<br>Ödeme: ${o.pay}`);
                    markers.push(marker);
                });

                document.getElementById('st-total').innerText = stats.total + " TL";
                document.getElementById('st-cash').innerText = stats.cash + " TL";
                document.getElementById('st-card').innerText = stats.card + " TL";
                document.getElementById('st-online').innerText = stats.online + " TL";
                document.getElementById('st-cancel').innerText = stats.cancel;
            });

            map.on('click', e => {
                if(isAdmin) return alert("Admin modunda sadece izleme yapabilirsiniz.");
                const price = prompt("Sipariş Tutarı:");
                const pay = prompt("Ödeme Türü (Nakit / Kredi Kartı / Online):");
                if(price && pay) {
                    db.collection("orders").add({
                        restaurant: currentRes,
                        price: price,
                        pay: pay,
                        lat: e.latlng.lat,
                        lng: e.latlng.lng,
                        status: "aktif",
                        time: new Date().getTime()
                    }).catch(err => alert("Firestore Hatası: " + err.message));
                }
            });
        }
    </script>
</body>
</html>
    </div>

    <div class="stats-bar" id="stats-panel" style="display:none;">
        <div class="stat-card"><h5>Toplam</h5><p id="st-total">0 TL</p></div>
        <div class="stat-card" style="border-color: #25d366"><h5>Nakit</h5><p id="st-cash">0 TL</p></div>
        <div class="stat-card" style="border-color: #3498db"><h5>Kart</h5><p id="st-card">0 TL</p></div>
        <div class="stat-card" style="border-color: #f39c12"><h5>Online</h5><p id="st-online">0 TL</p></div>
        <div class="stat-card" style="border-color: #e74c3c"><h5>İptal</h5><p id="st-cancel">0</p></div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // FIREBASE CONFIG (Senin görselinden kopyalandı)
        const firebaseConfig = {
            apiKey: "AIzaSyAdoBPDNNfgW8AZxpR3...", // Buraya görseldeki tam keyi yazabilirsin
            authDomain: "wpyonsip-6bbb5.firebaseapp.com",
            projectId: "wpyonsip-6bbb5",
            storageBucket: "wpyonsip-6bbb5.firebasestorage.app",
            messagingSenderId: "478685413866",
            appId: "1:478685413866:web:86a86..."
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentRes = "";
        let isAdmin = false;

        function login() {
            const name = document.getElementById('resName').value.trim();
            const pass = document.getElementById('resPass').value;

            if(name === "admin" && pass === "1234") {
                isAdmin = true;
                currentRes = "TÜM RESTORANLAR";
            } else if(name !== "" && pass !== "") {
                currentRes = name;
            } else {
                return alert("Bilgileri girin!");
            }
            
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('stats-panel').style.display = 'grid';
            initApp();
        }

        function initApp() {
            const map = L.map('map').setView([39.9334, 32.8597], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            // Verileri Firestore'dan Canlı Dinle
            let query = db.collection("orders");
            if(!isAdmin) query = query.where("restaurant", "==", currentRes);

            query.onSnapshot(snapshot => {
                let stats = { total: 0, cash: 0, card: 0, online: 0, cancel: 0 };
                
                snapshot.forEach(doc => {
                    const o = doc.data();
                    if(o.status === "iptal") {
                        stats.cancel++;
                    } else {
                        const price = parseFloat(o.price) || 0;
                        stats.total += price;
                        if(o.pay === "Nakit") stats.cash += price;
                        if(o.pay === "Kredi Kartı") stats.card += price;
                        if(o.pay === "Online") stats.online += price;
                    }
                    
                    // Haritaya işaretçi ekle
                    L.marker([o.lat, o.lng]).addTo(map).bindPopup(`<b>${o.restaurant}</b><br>${o.items}<br>${o.price} TL`);
                });

                // Panel Güncelle
                document.getElementById('st-total').innerText = stats.total + " TL";
                document.getElementById('st-cash').innerText = stats.cash + " TL";
                document.getElementById('st-card').innerText = stats.card + " TL";
                document.getElementById('st-online').innerText = stats.online + " TL";
                document.getElementById('st-cancel').innerText = stats.cancel;
            });

            map.on('click', e => {
                if(isAdmin) return alert("Admin olarak sipariş ekleyemezsiniz.");
                const price = prompt("Tutar girin:");
                const pay = prompt("Ödeme Türü (Nakit, Kredi Kartı, Online):");
                if(price) {
                    db.collection("orders").add({
                        restaurant: currentRes,
                        price: price,
                        pay: pay,
                        lat: e.latlng.lat,
                        lng: e.latlng.lng,
                        items: "Yeni Sipariş",
                        status: "aktif",
                        time: new Date().getTime()
                    });
                }
            });
        }
    </script>
</body>
</html>
