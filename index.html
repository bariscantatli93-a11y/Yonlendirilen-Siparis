<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sipariş SaaS - Yönetim Paneli</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { height: 60vh; width: 100%; border-radius: 15px; z-index: 10 !important; position: relative; }
        .stat-card { background: white; padding: 10px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; border-top: 4px solid #3b82f6; }
        .whatsapp-btn { background-color: #25D366; color: white !important; padding: 10px; border-radius: 8px; font-weight: bold; display: block; text-align: center; margin-top: 10px; text-decoration: none; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="login-screen" class="fixed inset-0 bg-white z-[9999] flex items-center justify-center p-6">
        <div class="w-full max-w-md space-y-6 text-center">
            <h1 class="text-3xl font-extrabold text-blue-600 italic">Sipariş SaaS</h1>
            <p class="text-gray-500">Lütfen Restoranınızı Seçin</p>
            
            <select id="rest-select" class="w-full p-4 border-2 border-blue-100 rounded-xl bg-gray-50 text-lg font-semibold outline-none focus:border-blue-500">
                <option value="">-- Restoran Seçiniz --</option>
                <option value="admin">YÖNETİCİ (Admin)</option>
                <option value="Lezzet Döner">Lezzet Döner</option>
                <option value="Pizza Han">Pizza Han</option>
                <option value="Saray Kebap">Saray Kebap</option>
                <option value="Dükkan 1">Dükkan 1</option>
            </select>

            <button onclick="handleLogin()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold text-xl shadow-lg hover:bg-blue-700 transition">Sisteme Giriş Yap</button>
        </div>
    </div>

    <div id="main-panel" class="hidden pb-20">
        <div class="grid grid-cols-2 gap-3 p-4">
            <div class="stat-card"><p class="text-xs text-gray-500">TOPLAM CİRO</p><p id="total-ciro" class="text-xl font-bold text-blue-600">0 TL</p></div>
            <div class="stat-card"><p class="text-xs text-gray-500">SİPARİŞ ADEDİ</p><p id="total-adet" class="text-xl font-bold text-orange-600">0</p></div>
        </div>

        <div class="px-4"><div id="map"></div></div>

        <div id="admin-area" class="hidden p-4 mt-4 bg-white mx-4 rounded-xl shadow">
            <h2 class="font-bold border-b pb-2 mb-2">Restoran Özetleri</h2>
            <div id="summary-list" class="space-y-2 text-sm text-gray-700"></div>
        </div>

        <button onclick="location.reload()" class="w-full mt-10 text-gray-400 text-xs">Oturumu Kapat</button>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCi...", 
            authDomain: "wpyonsip-6bbb5.firebaseapp.com",
            projectId: "wpyonsip-6bbb5",
            storageBucket: "wpyonsip-6bbb5.appspot.com",
            messagingSenderId: "338804071850",
            appId: "1:338804071850:web:138a2e5d590403756b66e3"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let map, userRole, currentRest;

        function handleLogin() {
            const select = document.getElementById('rest-select');
            currentRest = select.value;
            if(!currentRest) return alert("Lütfen bir restoran seçin!");
            
            userRole = (currentRest === 'admin') ? 'admin' : 'restoran';
            
            document.getElementById('login-screen').remove();
            document.getElementById('main-panel').classList.remove('hidden');
            if(userRole === 'admin') document.getElementById('admin-area').classList.remove('hidden');

            initMap();
            loadOrders();
        }

        function initMap() {
            map = L.map('map').setView([39.9334, 32.8597], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            map.on('click', function(e) {
                if(userRole === 'admin') return;
                const tutar = prompt(currentRest + " için Sipariş Tutarı:", "150");
                if(!tutar) return;

                db.collection("orders").add({
                    restoran: currentRest,
                    tutar: parseFloat(tutar),
                    lat: e.latlng.lat,
                    lng: e.latlng.lng,
                    tarih: firebase.firestore.FieldValue.serverTimestamp()
                });
            });
        }

        function loadOrders() {
            db.collection("orders").orderBy("tarih", "desc").onSnapshot(snapshot => {
                let stats = { ciro: 0, adet: 0 };
                let rSummary = {};
                
                snapshot.forEach(doc => {
                    const d = doc.data();
                    if(userRole === 'admin' || d.restoran === currentRest) {
                        stats.ciro += d.tutar; stats.adet++;
                        
                        const waMsg = encodeURIComponent(`Sipariş!\nRestoran: ${d.restoran}\nTutar: ${d.tutar} TL\nKonum: https://www.google.com/maps?q=${d.lat},${d.lng}`);
                        L.circleMarker([d.lat, d.lng], {color: 'red', radius: 10}).addTo(map)
                         .bindPopup(`<b>${d.restoran}</b><br>${d.tutar} TL<br><a href="https://wa.me/?text=${waMsg}" class="whatsapp-btn">Kuryeye Gönder</a>`);
                    }
                    if(!rSummary[d.restoran]) rSummary[d.restoran] = {s:0, t:0};
                    rSummary[d.restoran].s++; rSummary[d.restoran].t += d.tutar;
                });

                document.getElementById('total-ciro').innerText = stats.ciro + " TL";
                document.getElementById('total-adet').innerText = stats.adet;
                
                if(userRole === 'admin') {
                    let h = '';
                    for(let r in rSummary) h += `<div class='flex justify-between'><span>${r}:</span> <b>${rSummary[r].s} Sip. / ${rSummary[r].t} TL</b></div>`;
                    document.getElementById('summary-list').innerHTML = h;
                }
            });
        }
    </script>
</body>
</html>
