<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sipariş SaaS - Profesyonel Yönetim Paneli</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #e63946; --secondary: #1d3557; --accent: #2ecc71; --admin: #8e44ad; }
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background: #f4f7f6; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        #auth-screen { position: fixed; inset: 0; background: var(--secondary); z-index: 2000; display: flex; align-items: center; justify-content: center; color: white; }
        .login-box { background: white; color: #333; padding: 30px; border-radius: 20px; width: 85%; max-width: 350px; text-align: center; }
        .stats-bar { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; padding: 10px; background: #fff; border-bottom: 2px solid #ddd; }
        .stat-card { background: #fff; padding: 10px; border-radius: 10px; text-align: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); border-bottom: 3px solid var(--primary); }
        .stat-card h5 { margin: 0; font-size: 11px; color: #777; }
        .stat-card p { margin: 5px 0 0 0; font-weight: bold; font-size: 14px; color: var(--secondary); }
        #map { flex: 1; z-index: 1; }
        #admin-panel { height: 180px; background: white; overflow-y: auto; display: none; border-top: 3px solid var(--admin); padding: 10px; font-size: 12px; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #eee; padding: 8px; text-align: left; }
        td { padding: 8px; border-bottom: 1px solid #eee; }
        .modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 15px; z-index: 3000; width: 80%; max-width: 300px; box-shadow: 0 0 20px rgba(0,0,0,0.5); }
        .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 2900; }
        input, select, button { width: 100%; padding: 10px; margin: 5px 0; border-radius: 8px; border: 1px solid #ddd; }
        .btn-add { background: var(--primary); color: white; border: none; font-weight: bold; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="login-box">
            <h2 style="color: var(--primary)">Sipariş Paneli</h2>
            <input type="text" id="resName" placeholder="Restoran Adı">
            <input type="password" id="resPass" placeholder="Şifre">
            <button class="btn-add" onclick="login()">GİRİŞ YAP</button>
            <p style="color: #999; font-size: 11px;">Admin için: admin / 1234</p>
        </div>
    </div>

    <div class="stats-bar" id="stats-panel" style="display:none;">
        <div class="stat-card"><h5>Ciro</h5><p id="st-total">0 TL</p></div>
        <div class="stat-card" style="border-color:#2ecc71"><h5>Nakit</h5><p id="st-cash">0 TL</p></div>
        <div class="stat-card" style="border-color:#3498db"><h5>Kart</h5><p id="st-card">0 TL</p></div>
        <div class="stat-card" style="border-color:#f1c40f"><h5>Online</h5><p id="st-online">0 TL</p></div>
        <div class="stat-card" style="border-color:#e67e22"><h5>Adet</h5><p id="st-count">0</p></div>
        <button onclick="location.reload()" style="font-size:10px; padding:2px;">Çıkış</button>
    </div>

    <div id="map"></div>

    <div id="admin-panel">
        <h4 style="margin:0 0 10px 0">Restoran Özetleri</h4>
        <table>
            <thead><tr><th>Dükkan</th><th>Sip.</th><th>Toplam Ciro</th></tr></thead>
            <tbody id="admin-tbody"></tbody>
        </table>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="modal" id="order-modal">
        <h4 style="margin:0">Yeni Sipariş</h4>
        <input type="number" id="orderPrice" placeholder="Tutar (TL)">
        <select id="orderPay">
            <option value="Nakit">Nakit</option>
            <option value="Kredi Kartı">Kredi Kartı</option>
            <option value="Online">Online</option>
        </select>
        <select id="orderSource">
            <option value="Manuel">Dükkan Siparişi</option>
            <option value="Yemeksepeti">Yemeksepeti</option>
            <option value="Getir">Getir</option>
            <option value="Trendyol">Trendyol Go</option>
        </select>
        <button class="btn-add" onclick="saveOrder()">KAYDET</button>
        <button onclick="closeModal()" style="background:#eee; border:none;">İptal</button>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAdoBPDNNfgW8AZxpR3-pUjH_M6_7D-X_U",
            authDomain: "wpyonsip-6bbb5.firebaseapp.com",
            projectId: "wpyonsip-6bbb5",
            storageBucket: "wpyonsip-6bbb5.firebasestorage.app",
            messagingSenderId: "478685413866",
            appId: "1:478685413866:web:86a86e92c6086e3f53831a"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let currentRes = "", isAdmin = false, map, markers = [], tempCoords = null;

        function login() {
            const name = document.getElementById('resName').value.trim();
            const pass = document.getElementById('resPass').value;
            if(name === "admin" && pass === "1234") { isAdmin = true; currentRes = "Admin"; document.getElementById('admin-panel').style.display='block'; }
            else if(name) { currentRes = name; } else return;
            document.getElementById('auth-screen').style.display='none';
            document.getElementById('stats-panel').style.display='grid';
            initApp();
        }

        function initApp() {
            map = L.map('map').setView([39.93, 32.85], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            let q = db.collection("orders");
            if(!isAdmin) q = q.where("restaurant", "==", currentRes);

            q.onSnapshot(snap => {
                let s = { t:0, n:0, k:0, o:0, c:0 }, resList = {};
                markers.forEach(m => map.removeLayer(m));
                markers = [];

                snap.forEach(doc => {
                    const d = doc.data(); const p = parseFloat(d.price) || 0;
                    s.c++; s.t += p;
                    if(d.pay === "Nakit") s.n += p;
                    if(d.pay === "Kredi Kartı") s.k += p;
                    if(d.pay === "Online") s.o += p;

                    if(isAdmin) {
                        if(!resList[d.restaurant]) resList[d.restaurant] = { c:0, t:0 };
                        resList[d.restaurant].c++; resList[d.restaurant].t += p;
                    }

                    const m = L.circleMarker([d.lat, d.lng], {radius:7, color: d.source=="Getir"?"purple":d.source=="Yemeksepeti"?"pink":"blue"}).addTo(map)
                        .bindPopup(`${d.restaurant}<br>${p} TL - ${d.pay}`);
                    markers.push(m);
                });

                document.getElementById('st-total').innerText = s.t+" TL";
                document.getElementById('st-cash').innerText = s.n+" TL";
                document.getElementById('st-card').innerText = s.k+" TL";
                document.getElementById('st-online').innerText = s.o+" TL";
                document.getElementById('st-count').innerText = s.c;

                if(isAdmin) {
                    const tb = document.getElementById('admin-tbody'); tb.innerHTML = "";
                    for(let r in resList) tb.innerHTML += `<tr><td>${r}</td><td>${resList[r].c}</td><td>${resList[r].t} TL</td></tr>`;
                }
            });

            map.on('click', e => { if(isAdmin) return; tempCoords = e.latlng; document.getElementById('order-modal').style.display='block'; document.getElementById('overlay').style.display='block'; });
        }

        function saveOrder() {
            const p = document.getElementById('orderPrice').value;
            const pay = document.getElementById('orderPay').value;
            const src = document.getElementById('orderSource').value;
            if(!p) return;
            db.collection("orders").add({ restaurant: currentRes, price: p, pay: pay, source: src, lat: tempCoords.lat, lng: tempCoords.lng, time: Date.now() });
            closeModal();
        }

        function closeModal() { document.getElementById('order-modal').style.display='none'; document.getElementById('overlay').style.display='none'; }
    </script>
</body>
</html>
