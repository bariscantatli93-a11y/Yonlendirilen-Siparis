<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sipariş SaaS - Kurye Sistemi</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { height: 65vh; width: 100%; border-radius: 15px; z-index: 1; }
        .stat-card { background: white; padding: 10px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center; }
        .whatsapp-btn { background-color: #25D366; color: white !important; padding: 10px; border-radius: 8px; font-weight: bold; display: block; text-align: center; margin-top: 10px; text-decoration: none; }
    </style>
</head>
<body class="bg-gray-100">

    <div id="login-screen" class="fixed inset-0 bg-white z-[9999] flex items-center justify-center p-6">
        <div class="w-full max-w-md space-y-4">
            <h1 class="text-2xl font-bold text-center text-blue-600">SaaS Sipariş Paneli</h1>
            <input type="text" id="username" placeholder="Kullanıcı Adı (admin veya Dükkan Adı)" class="w-full p-4 border rounded-xl">
            <input type="password" id="password" placeholder="Şifre" class="w-full p-4 border rounded-xl">
            <button onclick="handleLogin()" class="w-full bg-blue-600 text-white p-4 rounded-xl font-bold">Giriş Yap</button>
        </div>
    </div>

    <div id="main-panel" class="hidden">
        <div class="grid grid-cols-2 gap-2 p-4">
            <div class="stat-card border-l-4 border-red-500"><p class="text-xs">Ciro</p><p id="total-ciro" class="font-bold text-lg">0 TL</p></div>
            <div class="stat-card border-l-4 border-green-500"><p class="text-xs">Nakit</p><p id="total-nakit" class="font-bold text-lg">0 TL</p></div>
            <div class="stat-card border-l-4 border-blue-500"><p class="text-xs">Kart</p><p id="total-kart" class="font-bold text-lg">0 TL</p></div>
            <div class="stat-card border-l-4 border-orange-500"><p class="text-xs">Adet</p><p id="total-adet" class="font-bold text-lg">0</p></div>
            <button onclick="location.reload()" class="col-span-2 bg-gray-200 p-2 rounded-lg text-xs">Çıkış Yap</button>
        </div>
        <div class="px-4"><div id="map"></div></div>
        <div id="admin-table" class="hidden p-4">
            <h3 class="font-bold mb-2">Restoran Özetleri</h3>
            <div id="summary-content" class="bg-white rounded-lg shadow p-2 text-sm"></div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCi...",
            authDomain: "wpyonsip-6bbb5.firebaseapp.com",
            projectId: "wpyonsip-6bbb5",
            storageBucket: "wpyonsip-6bbb5.appspot.com",
            messagingSenderId: "338804071850",
            appId: "1:338804071850:web:138a2e5d590403756b66e3"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let map, userRole, currentRest;

        function handleLogin() {
            const user = document.getElementById('username').value.trim();
            if(!user) return alert("İsim giriniz");
            
            userRole = (user.toLowerCase() === 'admin') ? 'admin' : 'restoran';
            currentRest = user;
            
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-panel').style.display = 'block';
            if(userRole === 'admin') document.getElementById('admin-table').style.display = 'block';

            initMap();
            loadOrders();
        }

        function initMap() {
            map = L.map('map').setView([39.9334, 32.8597], 12);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            map.on('click', function(e) {
                if(userRole === 'admin') return;
                const tutar = prompt("Tutar (TL):", "100");
                if(!tutar) return;
                const tip = prompt("Ödeme (Nakit/Kart/Online):", "Nakit");

                db.collection("orders").add({
                    restoran: currentRest,
                    tutar: parseFloat(tutar),
                    tip: tip,
                    lat: e.latlng.lat,
                    lng: e.latlng.lng,
                    tarih: firebase.firestore.FieldValue.serverTimestamp()
                });
            });
        }

        function loadOrders() {
            db.collection("orders").orderBy("tarih", "desc").onSnapshot(snapshot => {
                let stats = { c:0, n:0, k:0, a:0 };
                let rSummary = {};
                
                snapshot.forEach(doc => {
                    const d = doc.data();
                    if(userRole === 'admin' || d.restoran === currentRest) {
                        stats.c += d.tutar; stats.a++;
                        if(d.tip === 'Nakit') stats.n += d.tutar;
                        if(d.tip === 'Kart') stats.k += d.tutar;

                        const waMsg = encodeURIComponent(`Sipariş!\nRestoran: ${d.restoran}\nTutar: ${d.tutar} TL\nKonum: https://www.google.com/maps?q=${d.lat},${d.lng}`);
                        L.circleMarker([d.lat, d.lng], {color: 'blue', radius: 8}).addTo(map)
                         .bindPopup(`<b>${d.restoran}</b><br>${d.tutar} TL<br><a href="https://wa.me/?text=${waMsg}" class="whatsapp-btn">Kuryeye WhatsApp At</a>`);
                    }
                    if(!rSummary[d.restoran]) rSummary[d.restoran] = {s:0, t:0};
                    rSummary[d.restoran].s++; rSummary[d.restoran].t += d.tutar;
                });

                document.getElementById('total-ciro').innerText = stats.c + " TL";
                document.getElementById('total-nakit').innerText = stats.n + " TL";
                document.getElementById('total-kart').innerText = stats.k + " TL";
                document.getElementById('total-adet').innerText = stats.a;
                
                if(userRole === 'admin') {
                    let h = '';
                    for(let r in rSummary) h += `<div>${r}: ${rSummary[r].s} Sipariş / ${rSummary[r].t} TL</div>`;
                    document.getElementById('summary-content').innerHTML = h;
                }
            });
        }
    </script>
</body>
</html>
