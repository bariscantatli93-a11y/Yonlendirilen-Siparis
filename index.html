<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Düzce Lojistik Paneli</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        #map { height: 35vh; width: 100%; border-radius: 20px; border: 3px solid white; z-index: 1; }
        .wa-btn { background: #25D366; color: white !important; padding: 5px 10px; border-radius: 8px; font-weight: bold; font-size: 11px; }
        .login-bg { background: #1e40af; height: 100vh; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 font-sans">

    <div id="login-screen" class="login-bg fixed inset-0 z-[9999]">
        <div class="w-full max-w-sm p-10 bg-white rounded-[30px] shadow-2xl text-center">
            <h1 class="text-2xl font-black text-blue-900 mb-6 tracking-tight">OPERASYON MERKEZİ</h1>
            <select id="role-select" class="w-full p-4 border-2 border-slate-100 rounded-2xl mb-4 font-bold outline-none text-center">
                <option value="">Giriş Türü</option>
                <option value="admin">ADMİN (MERKEZ)</option>
                <option value="Pizza">PİZZA ŞUBESİ</option>
                <option value="Döner">DÖNER ŞUBESİ</option>
                <option value="Kebap">KEBAP ŞUBESİ</option>
            </select>
            <button onclick="handleLogin()" class="w-full bg-blue-700 text-white p-4 rounded-2xl font-black shadow-lg">BAĞLAN</button>
        </div>
    </div>

    <div id="main-panel" class="hidden">
        <div class="p-5 bg-white shadow-sm flex justify-between items-center border-b">
            <h2 id="display-title" class="font-black text-blue-900 uppercase">Panel</h2>
            <button onclick="location.reload()" class="text-xs font-bold text-red-500">ÇIKIŞ</button>
        </div>

        <div class="grid grid-cols-2 gap-3 p-4">
            <div class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-blue-600">
                <p class="text-[9px] font-bold text-slate-400 uppercase">Ciro</p>
                <p id="total-ciro" class="text-lg font-black">0 TL</p>
            </div>
            <div class="bg-white p-4 rounded-2xl shadow-sm border-b-4 border-emerald-500">
                <p class="text-[9px] font-bold text-slate-400 uppercase">Sipariş</p>
                <p id="total-adet" class="text-lg font-black">0</p>
            </div>
        </div>

        <div id="map-area" class="px-4 mb-4 hidden"><div id="map"></div></div>

        <div id="list-area" class="px-4 pb-20 space-y-3"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
        // API KEY Buraya (Firebase'den kopyaladığın AIzaSy... ile başlayan kod)
        const config = {
            apiKey: "AIzaSyAdoBPDNNfgW8AZxpR3-FIvuYVtOazCysI",
            authDomain: "wpyonsip-6bbb5.firebaseapp.com",
            projectId: "wpyonsip-6bbb5",
            storageBucket: "wpyonsip-6bbb5.appspot.com",
            messagingSenderId: "338804071850",
            appId: "1:338804071850:web:138a2e5d590403756b66e3"
        };
        firebase.initializeApp(config);
        const db = firebase.firestore();

        let userRole, map;

        function handleLogin() {
            userRole = document.getElementById('role-select').value;
            if(!userRole) return alert("Seçim yap!");
            
            document.getElementById('login-screen').remove();
            document.getElementById('main-panel').classList.remove('hidden');
            document.getElementById('display-title').innerText = userRole;

            if(userRole !== 'admin') {
                document.getElementById('map-area').classList.remove('hidden');
                initMap();
            }
            fetchData();
        }

        function initMap() {
            map = L.map('map').setView([40.8438, 31.1565], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            map.on('click', e => {
                const t = prompt("Tutar:");
                if(t) db.collection("orders").add({
                    res: userRole, tutar: t, lat: e.latlng.lat, lng: e.latlng.lng, status: 'aktif', tarih: firebase.firestore.FieldValue.serverTimestamp()
                });
            });
        }

        function fetchData() {
            db.collection("orders").orderBy("tarih", "desc").onSnapshot(snap => {
                let html = ''; let ciro = 0; let adet = 0;
                
                snap.forEach(doc => {
                    const d = doc.data();
                    if(d.status === 'aktif' && (userRole === 'admin' || d.res === userRole)) {
                        ciro += parseFloat(d.tutar); adet++;
                        
                        // WhatsApp Mesajı Düzenlendi
                        const msg = `Sipariş Bildirisi!\nŞube: ${d.res}\nTutar: ${d.tutar} TL\nKonum: https://www.google.com/maps?q=${d.lat},${d.lng}`;
                        const waUrl = `https://wa.me/?text=${encodeURIComponent(msg)}`;

                        html += `
                        <div class="bg-white p-4 rounded-xl shadow-sm flex justify-between items-center border-l-4 ${userRole === 'admin' ? 'border-blue-800' : 'border-emerald-500'}">
                            <div class="text-xs">
                                <p class="font-black text-blue-900">${userRole === 'admin' ? d.res : 'Paket'}</p>
                                <p class="font-bold text-slate-500">${d.tutar} TL</p>
                            </div>
                            <div class="flex gap-2">
                                <a href="${waUrl}" target="_blank" class="wa-btn">KURYE ARA</a>
                                <button onclick="db.collection('orders').doc('${doc.id}').update({status:'iptal'})" class="text-red-500 font-bold text-[10px]">İPTAL</button>
                            </div>
                        </div>`;
                    }
                });
                document.getElementById('list-area').innerHTML = html;
                document.getElementById('total-ciro').innerText = ciro + " TL";
                document.getElementById('total-adet').innerText = adet;
            });
        }
    </script>
</body>
</html>
